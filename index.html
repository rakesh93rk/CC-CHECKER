<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LEVI INTERIOR - Sites</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap');

body{
  font-family:'SF Pro Display',sans-serif;
  background:linear-gradient(180deg,#e0e7ff 0%,#fff 100%);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.app-container{
  width:100%;
  max-width:460px;
  background:white;
  border-radius:28px;
  box-shadow:0 10px 25px rgba(0,0,0,0.1);
  padding:30px 20px;
}

h1{text-align:center;margin:10px 0;}
h2{text-align:center;font-size:16px;color:#555;}

.card{
  background:#f9f9ff;
  padding:14px;
  border-radius:18px;
  margin-top:12px;
}

.btn{
  padding:10px 14px;
  border-radius:14px;
  border:none;
  font-weight:600;
  margin-top:8px;
  cursor:pointer;
}

.btn-add{background:#e8fdf2;color:#14532d;}
.btn-room{background:#f1f5f9;color:#1e293b;}
.btn-edit{background:#fde68a;color:#713f12;}
.btn-del{background:#fecaca;color:#7f1d1d;}
.btn-pdf{background:#fee2e2;color:#7f1d1d;}

input{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid #ccc;
  margin-top:6px;
}

.site-list, .room-list{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:8px;
}

.site-item, .room-item-btn{
  padding:6px 10px;
  background:#eef2ff;
  border-radius:10px;
  cursor:pointer;
  font-size:13px;
  white-space:nowrap;
}

.site-item.active, .room-item-btn.active{
  background:#c7d2fe;
  font-weight:600;
}

.section-title{
  margin-top:10px;
  font-weight:700;
  color:#1e3a8a;
}

.row-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:13px;
  padding:4px 0;
  cursor:pointer;
}

.total-box{
  background:#dcfce7;
  padding:12px;
  border-radius:14px;
  margin-top:10px;
  font-weight:700;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* ---------- POPUP ---------- */
.popup-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  display:none;
  justify-content:center;
  align-items:center;
}

.popup{
  background:white;
  padding:20px;
  border-radius:18px;
  width:280px;
  text-align:center;
}

.popup-buttons{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="app-container">

<h1>LEVI INTERIOR</h1>
<h2>Sites List</h2>

<div class="card">
  <button class="btn btn-add" onclick="addSite()">âž• Add Site</button>
  <div id="sitesList" class="site-list"></div>
</div>

<div id="siteDetails" style="display:none">

  <div class="card">
    <b>Rooms</b>
    <div id="roomsList" class="room-list"></div>
  </div>

  <div class="card" id="roomPanel"></div>

  <div class="card">
    <b>All Items</b>
    <div id="allItemsList"></div>
  </div>

  <div class="total-box">
    <span id="totalAmount">Total: Rs. 0</span>
    <button class="btn btn-pdf" onclick="downloadPDF()">ðŸ“„ Download PDF</button>
  </div>

</div>

</div>

<!-- POPUP -->
<div class="popup-bg" id="popupBg">
  <div class="popup">
    <h3 id="popupTitle"></h3>
    <div id="popupContent"></div>
    <div class="popup-buttons" id="popupButtons"></div>
  </div>
</div>

<script>
let sites = JSON.parse(localStorage.getItem("sitesData")) || {};
let currentSite = null;
let currentRoom = null;

let popupRoom = null;
let popupIndex = null;
let popupSite = null;

const rooms = [
  "Master Bedroom","Children's Bedroom","Guest Bedroom","Hall",
  "TV Unit","Kitchen","Balcony","Utility","General"
];

function saveData(){
  localStorage.setItem("sitesData", JSON.stringify(sites));
}

/* ---------- SITES ---------- */
function renderSites(){
  const list = document.getElementById("sitesList");
  list.innerHTML="";
  Object.keys(sites).forEach(name=>{
    const div=document.createElement("div");
    div.className="site-item"+(name===currentSite?" active":"");
    div.innerText=name;
    div.onclick=()=>selectSite(name);
    div.ondblclick=()=>openSitePopup(name);
    list.appendChild(div);
  });
}

function addSite(){
  const name = prompt("Enter site name");
  if(!name) return;
  if(sites[name]) return alert("Site already exists");

  sites[name]={};
  rooms.forEach(r=>sites[name][r]=[]);
  saveData();
  renderSites();
}

/* ---------- SITE POPUP ---------- */
function openSitePopup(name){
  popupSite=name;
  document.getElementById("popupTitle").innerText=name;
  document.getElementById("popupContent").innerHTML="<p>Select action</p>";
  document.getElementById("popupButtons").innerHTML=`
    <button class="btn btn-edit" onclick="showEditSite()">Edit</button>
    <button class="btn btn-del" onclick="deleteSite()">Delete</button>
    <button class="btn" onclick="closePopup()">Close</button>
  `;
  showPopup();
}

function showEditSite(){
  document.getElementById("popupContent").innerHTML=`
    <input id="editInput" value="${popupSite}">
  `;
  document.getElementById("popupButtons").innerHTML=`
    <button class="btn btn-edit" onclick="saveEditSite()">Save</button>
    <button class="btn" onclick="openSitePopup('${popupSite}')">Back</button>
  `;
}

function saveEditSite(){
  const newName=document.getElementById("editInput").value.trim();
  if(!newName) return alert("Enter site name");
  if(sites[newName] && newName!==popupSite) return alert("Already exists");

  sites[newName]=sites[popupSite];
  delete sites[popupSite];
  if(currentSite===popupSite) currentSite=newName;

  saveData();
  closePopup();
  renderSites();
}

function deleteSite(){
  if(!confirm("Delete this site?")) return;
  delete sites[popupSite];
  if(currentSite===popupSite){
    currentSite=null;
    document.getElementById("siteDetails").style.display="none";
  }
  saveData();
  closePopup();
  renderSites();
}

/* ---------- ITEM POPUP ---------- */
function openItemPopup(room,idx){
  popupRoom=room;
  popupIndex=idx;
  const item=sites[currentSite][room][idx];

  document.getElementById("popupTitle").innerText=item.item;
  document.getElementById("popupContent").innerHTML="<p>Select action</p>";
  document.getElementById("popupButtons").innerHTML=`
    <button class="btn btn-edit" onclick="showEditItem()">Edit</button>
    <button class="btn btn-del" onclick="deleteItem()">Delete</button>
    <button class="btn" onclick="closePopup()">Close</button>
  `;
  showPopup();
}

function showEditItem(){
  const data=sites[currentSite][popupRoom][popupIndex];
  document.getElementById("popupContent").innerHTML=`
    <input id="editItemName" value="${data.item}">
    <input id="editItemAmt" type="number" value="${data.amt}">
  `;
  document.getElementById("popupButtons").innerHTML=`
    <button class="btn btn-edit" onclick="saveEditItem()">Save</button>
    <button class="btn" onclick="openItemPopup('${popupRoom}',${popupIndex})">Back</button>
  `;
}

function saveEditItem(){
  const newName=document.getElementById("editItemName").value;
  const newAmt=parseFloat(document.getElementById("editItemAmt").value);
  if(!newName || isNaN(newAmt)) return alert("Fill both fields");

  sites[currentSite][popupRoom][popupIndex]={item:newName,amt:newAmt};
  saveData();
  closePopup();
  renderAllItems();
  updateTotal();
}

function deleteItem(){
  if(!confirm("Delete this item?")) return;
  sites[currentSite][popupRoom].splice(popupIndex,1);
  saveData();
  closePopup();
  renderAllItems();
  updateTotal();
}

/* ---------- COMMON POPUP ---------- */
function showPopup(){
  document.getElementById("popupBg").style.display="flex";
}
function closePopup(){
  document.getElementById("popupBg").style.display="none";
}

/* ---------- à¤¬à¤¾à¤•à¥€ UI ---------- */
function selectSite(name){
  currentSite=name;
  currentRoom=null;
  renderSites();
  document.getElementById("siteDetails").style.display="block";
  renderRooms();
  renderRoomPanel();
  renderAllItems();
  updateTotal();
}

function renderRooms(){
  const list=document.getElementById("roomsList");
  list.innerHTML="";
  rooms.forEach(r=>{
    const div=document.createElement("div");
    div.className="room-item-btn"+(r===currentRoom?" active":"");
    div.innerText=r;
    div.onclick=()=>selectRoom(r);
    list.appendChild(div);
  });
}

function selectRoom(room){
  currentRoom=room;
  renderRooms();
  renderRoomPanel();
}

function renderRoomPanel(){
  if(!currentRoom){
    document.getElementById("roomPanel").innerHTML="<i>Select a room</i>";
    return;
  }
  document.getElementById("roomPanel").innerHTML=`
    <b>${currentRoom}</b>
    <input placeholder="Item name" id="itemInput">
    <input placeholder="Amount" type="number" id="amtInput">
    <button class="btn btn-room" onclick="addItem()">Add</button>
  `;
}

function addItem(){
  const item=document.getElementById("itemInput").value;
  const amt=parseFloat(document.getElementById("amtInput").value);
  if(!item || isNaN(amt)) return alert("Enter item and amount");

  sites[currentSite][currentRoom].push({item,amt});
  saveData();
  renderAllItems();
  updateTotal();
  document.getElementById("itemInput").value="";
  document.getElementById("amtInput").value="";
}

function renderAllItems(){
  const box=document.getElementById("allItemsList");
  box.innerHTML="";

  rooms.forEach(room=>{
    if(sites[currentSite][room].length>0){
      const title=document.createElement("div");
      title.className="section-title";
      title.innerText=room.toUpperCase();
      box.appendChild(title);

      sites[currentSite][room].forEach((i,idx)=>{
        const row=document.createElement("div");
        row.className="row-item";
        row.innerHTML=`<span>${i.item}</span><span>Rs. ${i.amt}</span>`;
        row.ondblclick=()=>openItemPopup(room,idx);
        box.appendChild(row);
      });
    }
  });
}

function updateTotal(){
  if(!currentSite) return;
  let total=0;
  rooms.forEach(r=>{
    sites[currentSite][r].forEach(i=>total+=i.amt);
  });
  document.getElementById("totalAmount").innerText="Total: Rs. "+total.toFixed(2);
}

/* ---------- PDF HELPERS ---------- */
function drawHeader(doc){
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("LEVI INTERIOR - SITE REPORT",105,15,{align:"center"});
  doc.setFontSize(12);
  doc.setFont("helvetica","normal");
  doc.text("Site: " + currentSite,10,25);
}

function addPageNumbers(doc){
  const pageCount = doc.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(10);
    doc.text("Page " + i + " of " + pageCount,105,290,{align:"center"});
  }
}

/* ---------- PDF ---------- */
function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  drawHeader(doc);
  let y = 35;
  let grandTotal = 0;

  rooms.forEach(room=>{
    if(sites[currentSite][room].length > 0){

      doc.setFont("helvetica","bold");
      doc.text(room.toUpperCase(),10,y);
      y+=6;

      doc.setFont("helvetica","normal");
      doc.text("Item",12,y);
      doc.text("Amount",170,y,{align:"right"});
      y+=4;
      doc.line(10,y,200,y);
      y+=4;

      let roomTotal = 0;

      sites[currentSite][room].forEach(i=>{
        doc.text(i.item,12,y);
        doc.text("Rs. " + i.amt.toFixed(2),170,y,{align:"right"});
        roomTotal += i.amt;
        grandTotal += i.amt;
        y+=6;

        if(y>270){
          doc.addPage();
          drawHeader(doc);
          y = 35;
        }
      });

      doc.setFont("helvetica","bold");
      doc.text("Room Total: Rs. " + roomTotal.toFixed(2),170,y,{align:"right"});
      y+=4;
      doc.line(10,y,200,y);
      y+=10;
    }
  });

  doc.setFontSize(14);
  doc.text("Grand Total: Rs. " + grandTotal.toFixed(2),170,y,{align:"right"});

  addPageNumbers(doc);
  doc.save(currentSite+"_report.pdf");
}

renderSites();
</script>

</body>
</html>
